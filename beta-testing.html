<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mocha OS</title>
  <link rel="icon" type="image/x-icon" href="https://img.icons8.com/fluency/96/linux.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

    /* GLOBAL RESET & GARUDA VARIABLES */
    :root {
        --garuda-bg: #0d0d18;
        --garuda-pink: #ff007c;
        --garuda-cyan: #00d9ff;
        --garuda-purple: #bd93f9;
        --glass: rgba(20, 20, 35, 0.6);
        --border-grad: linear-gradient(45deg, #ff007c, #00d9ff);
        --dock-bg: rgba(10, 10, 20, 0.85);
    }

    * { box-sizing: border-box; user-select: none; outline: none; }
    input, textarea { user-select: text; cursor: text; }

    /* =========================================
       CORE STYLES & WALLPAPER
       ========================================= */
    body {
      margin: 0; padding: 0;
      /* THE MOCHA/DR460NIZED WALLPAPER */
      background: url('https://images.wallpapersden.com/image/download/minimalist-landscape-digital-art_bG1lZmuUmZqaraWkpJRnamtlrWZpaWU.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: "Fira Sans", sans-serif;
      overflow: hidden; height: 100vh; width: 100vw;
      color: #eee;
    }

    /* PERFORMANCE MODE */
    body.perf-mode * {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background-color: #0d0d18 !important;
        box-shadow: none !important;
    }

    /* =========================================
       TOP BAR (Global Menu)
       ========================================= */
    #top-bar {
        position: fixed; top: 0; left: 0; width: 100%; height: 32px;
        background: rgba(10, 10, 15, 0.4);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; z-index: 2000;
        font-size: 13px; font-weight: 600;
        color: #fff;
    }

    .tb-left { display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
    .tb-left:hover { color: var(--garuda-cyan); text-shadow: 0 0 10px var(--garuda-cyan); }

    .tb-center { position: absolute; left: 50%; transform: translateX(-50%); opacity: 0.9; letter-spacing: 0.5px; }

    .tb-right { display: flex; gap: 15px; align-items: center; font-size: 12px; }
    .tb-right i { cursor: pointer; transition: 0.2s; }
    .tb-right i:hover { color: var(--garuda-pink); }

    /* =========================================
       DESKTOP ICONS
       ========================================= */
    .desktop { 
      position: absolute; top: 50px; left: 20px; bottom: 100px; 
      display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; 
      gap: 20px; z-index: 1; 
    }
    .icon { 
      text-align: center; cursor: pointer; color: white; width: 80px; 
      transition: 0.2s; text-shadow: 0 2px 5px rgba(0,0,0,0.8); 
      display: flex; flex-direction: column; align-items: center; margin-right: 10px; 
    }
    .icon:hover { transform: scale(1.05); background: rgba(255,255,255,0.05); border-radius: 10px; }
    .icon img { width: 48px; height: 48px; margin-bottom: 5px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6)); }
    .icon span { font-size: 12px; font-weight: 500; text-shadow: 0 0 5px rgba(0,0,0,0.8); }

    /* =========================================
       BOTTOM DOCK (Floating)
       ========================================= */
    .dock-container {
        position: fixed; bottom: 15px; width: 100%;
        display: flex; justify-content: center;
        z-index: 1000;
    }

    .dock { 
        height: 64px; min-width: 300px;
        background: var(--dock-bg);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 20px;
        display: flex; align-items: center; justify-content: center;
        padding: 0 15px; gap: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        transition: 0.3s cubic-bezier(0.25, 1.5, 0.5, 1);
    }

    .dock img { 
        width: 48px; height: 48px; cursor: pointer; 
        transition: 0.3s cubic-bezier(0.25, 1.5, 0.5, 1); 
        border-radius: 8px;
        filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
    }

    .dock img:hover { 
        transform: translateY(-15px) scale(1.2); 
        margin: 0 10px;
    }

    .dock img.active {
        box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        background: rgba(255,255,255,0.1);
    }

    /* =========================================
       SENTINEL (Adjusted Position)
       ========================================= */
    #sentinel {
      position: fixed; top: 60%; right: 30px; transform: translateY(-50%);
      width: 64px; min-height: 220px; max-height: 70vh;
      background: rgba(13, 13, 24, 0.6);
      backdrop-filter: blur(40px) saturate(180%);
      border-radius: 24px; 
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 0 15px rgba(0, 217, 255, 0.1);
      transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1), background 0.6s ease;
      display: flex; flex-direction: column; align-items: center; 
      padding: 20px 0; 
      z-index: 900; overflow: hidden; color: var(--garuda-cyan);
    }
    #sentinel:hover { width: 320px; background: rgba(13, 13, 24, 0.9); border-color: var(--garuda-pink); }

    .header { width: 100%; flex-shrink: 0; z-index: 2; text-align: center; }
    .stage { flex-grow: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; z-index: 1; margin-top: 20px; }
    #viz-canvas { position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; opacity: 0.3; transition: opacity 0.5s; }
    #sentinel:hover #viz-canvas { opacity: 0.7; }

    .controls-layer { width: 100%; padding: 0 20px; display: flex; flex-direction: column; align-items: center; opacity: 0; transform: scale(0.95); transition: 0.4s 0.05s; pointer-events: none; display: none; }
    #sentinel:hover .controls-layer { opacity: 1; transform: scale(1); pointer-events: all; display: flex; }
    .track-info { text-align: center; margin-bottom: 20px; width: 100%; }
    .t-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: uppercase; letter-spacing: 1px; }
    .t-artist { font-size: 0.7rem; color: var(--garuda-purple); text-transform: uppercase; letter-spacing: 2px; }
    .btn-row { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .icon-btn { color: var(--garuda-cyan); font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
    .icon-btn:hover { color: #fff; transform: scale(1.1); text-shadow: 0 0 10px var(--garuda-cyan); }
    .play-circle { width: 52px; height: 52px; background: linear-gradient(45deg, var(--garuda-pink), var(--garuda-purple)); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; transition: 0.3s; }
    .play-circle:hover { transform: scale(1.1); box-shadow: 0 0 25px var(--garuda-pink); }

    .playlist-box { width: 100%; max-height: 200px; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; display: flex; flex-direction: column; gap: 6px; }
    .playlist-box::-webkit-scrollbar { width: 3px; }
    .playlist-box::-webkit-scrollbar-thumb { background: var(--garuda-pink); border-radius: 2px; }
    .pl-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; color: #aaa; transition: 0.2s; border: 1px solid transparent; }
    .pl-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .pl-item.active { background: rgba(255, 0, 124, 0.2); color: #fff; font-weight: 700; border: 1px solid var(--garuda-pink); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .pl-title { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: uppercase; letter-spacing: 0.5px; }
    .pl-anim { display: flex; gap: 2px; align-items: flex-end; height: 10px; opacity: 0; }
    .pl-item.active .pl-anim { opacity: 1; }
    .bar { width: 2px; background: #fff; animation: bounce 0.4s infinite alternate; }
    .bar:nth-child(1) { animation-duration: 0.5s; } .bar:nth-child(2) { animation-duration: 0.4s; } .bar:nth-child(3) { animation-duration: 0.6s; }
    @keyframes bounce { 0% { height: 2px; } 100% { height: 12px; } }

    .s-actions { display: flex; justify-content: space-between; width: 100%; background: rgba(0,0,0,0.2); border-radius: 16px; padding: 10px 20px; }
    .act-btn { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
    .act-btn:hover { background: rgba(255,255,255,0.15); }
    .act-btn.active { background: var(--garuda-cyan); color: #000; box-shadow: 0 0 15px var(--garuda-cyan); }

    /* =========================================
       START MENU (Tweaked Position)
       ========================================= */
    #start-menu {
        position: fixed; top: 40px; left: 10px; 
        width: 400px; height: 500px;
        background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(30px);
        border: 1px solid var(--garuda-purple); border-radius: 12px;
        display: none; flex-direction: column; padding: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2001;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); opacity: 0;
        transform: translateY(-10px);
    }
    #start-menu.active { display: flex; opacity: 1; transform: translateY(0); }
    .sm-search { width: 100%; padding: 10px 15px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; margin-bottom: 20px; }
    .sm-search:focus { border-color: var(--garuda-cyan); outline: none; }
    .sm-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; overflow-y: auto; flex-grow: 1; }
    .sm-app { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; border-radius: 8px; padding: 10px; }
    .sm-app:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
    .sm-app img { width: 42px; height: 42px; margin-bottom: 5px; }
    .sm-app span { font-size: 11px; color: white; text-align: center; }
    .sm-footer { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
    .sm-user { display: flex; align-items: center; gap: 10px; }
    .sm-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid var(--garuda-cyan); }
    .sm-power { cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
    .sm-power:hover { background: var(--garuda-pink); box-shadow: 0 0 10px var(--garuda-pink); }

    /* =========================================
       DEV PANEL & NOTIFICATIONS
       ========================================= */
    #dev-panel {
        position: fixed; top: 0; right: -400px; width: 350px; height: 100%;
        background: rgba(10, 10, 10, 0.95); border-left: 2px solid var(--garuda-cyan);
        z-index: 999999; color: var(--garuda-cyan); font-family: monospace; padding: 20px;
        transition: right 0.3s ease; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
    }
    #dev-panel.active { right: 0; }
    .dev-section { border: 1px solid rgba(0, 217, 255, 0.3); padding: 10px; margin-bottom: 10px; }
    .notification-area { position: fixed; top: 50px; right: 20px; width: 300px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: rgba(20, 20, 30, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--garuda-cyan); border-radius: 10px; padding: 15px; color: white; transform: translateX(120%); transition: 0.3s; pointer-events: all; box-shadow: 0 0 15px rgba(0, 217, 255, 0.2); display: flex; gap: 10px; align-items: center; }
    .toast.show { transform: translateX(0); }

    /* =========================================
       AUTH
       ========================================= */
    #auth-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(30px); z-index: 99999; display: flex; justify-content: center; align-items: center; transition: 0.6s; }
    .auth-container { background: rgba(20,20,30,0.6); border: 1px solid var(--garuda-purple); padding: 40px; border-radius: 16px; width: 350px; display: none; flex-direction: column; align-items: center; text-align: center; color: white; box-shadow: 0 0 30px rgba(189, 147, 249, 0.3); }
    .auth-input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; outline: none; text-align: center; transition: 0.3s; }
    .auth-input:focus { border-color: var(--garuda-cyan); box-shadow: 0 0 10px var(--garuda-cyan); }
    .auth-btn { margin-top: 15px; padding: 10px 25px; border-radius: 20px; background: linear-gradient(45deg, var(--garuda-pink), var(--garuda-purple)); color: white; font-weight: bold; border: none; cursor: pointer; width: 100%; transition: 0.3s; }
    .auth-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--garuda-pink); }

    /* =========================================
       WINDOWS
       ========================================= */
    .window { 
        position: absolute; width: 800px; height: 550px; 
        background: rgba(15, 15, 22, 0.9); backdrop-filter: blur(25px); 
        border: 2px solid var(--garuda-purple); border-radius: 8px;
        border-image: var(--border-grad); border-image-slice: 1;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); 
        display: none; top: 100px; left: 100px; overflow: hidden; 
        z-index: 100; flex-direction: column; 
    }
    .window.maximized { top: 32px !important; left: 0 !important; width: 100% !important; height: calc(100% - 32px) !important; border-radius: 0; border: none; }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .title-bar { background: rgba(0,0,0,0.3); color: #eee; padding: 10px 15px; cursor: move; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; font-weight: bold; letter-spacing: 0.5px; }
    .controls { display: flex; gap: 8px; }
    .ctl-btn { width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; transition: 0.2s; }
    .close { background: #ff5f56; } .min { background: #ffbd2e; } .max { background: #27c93f; }
    .ctl-btn:hover { transform: scale(1.2); }
    .content { flex-grow: 1; background: rgba(255,255,255,0.02); overflow: hidden; position: relative; display: flex; flex-direction: column; }
    .resize-handle { width: 15px; height: 15px; position: absolute; bottom: 0; right: 0; cursor: nwse-resize; z-index: 10; }

    /* =========================================
       APP SPECIFIC STYLES
       ========================================= */
    .win10-explorer { display: flex; flex-direction: column; height: 100%; background: #282a36; color: #f8f8f2; }
    .ribbon { background: #181921; border-bottom: 1px solid #44475a; }
    .ribbon-tabs { display: flex; background: #181921; border-bottom: 1px solid #44475a; }
    .r-tab { padding: 5px 15px; font-size: 12px; cursor: pointer; color: #bd93f9; }
    .r-tab.active { background: #44475a; color: #fff; border-bottom: 2px solid var(--garuda-pink); }
    .ribbon-toolbar { padding: 8px 10px; display: flex; gap: 15px; height: 60px; align-items: center; }
    .r-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; width: 60px; text-align: center; color: #f8f8f2; }
    .r-btn:hover { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .address-row { display: flex; align-items: center; padding: 8px 10px; background: #282a36; border-bottom: 1px solid #44475a; gap: 10px; }
    .nav-arrows i { color: #f8f8f2; cursor: pointer; }
    .address-bar { flex-grow: 1; background: #181921; border: 1px solid #44475a; padding: 4px 8px; font-size: 12px; display: flex; align-items: center; gap: 5px; height: 26px; color: #f8f8f2; }
    .explorer-body { display: flex; flex-grow: 1; overflow: hidden; }
    .nav-pane { width: 200px; background: #21222c; border-right: 1px solid #44475a; padding: 10px 0; }
    .nav-item { display: flex; align-items: center; padding: 6px 15px; font-size: 13px; cursor: pointer; gap: 8px; color: #f8f8f2; }
    .nav-item:hover { background: #44475a; }
    .main-pane { flex-grow: 1; background: #282a36; padding: 10px; }
    .w-file { width: 90px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px; cursor: pointer; color: #f8f8f2; transition: 0.2s; }
    .w-file:hover { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .w-file.selected { background: rgba(189, 147, 249, 0.3); border: 1px solid var(--garuda-purple); border-radius: 4px; }
    .status-bar { height: 24px; background: #181921; color: #f8f8f2; font-size: 11px; display: flex; align-items: center; padding: 0 10px; }

    .browser-bar { display: flex; gap: 10px; padding: 8px; background: #181921; align-items: center; }
    .browser-tabs { display: flex; background: #0d0d12; padding-top: 5px; padding-left: 10px; gap: 5px; }
    .b-tab { background: #181921; padding: 5px 15px; border-radius: 8px 8px 0 0; font-size: 12px; cursor: pointer; color: #aaa; }
    .b-tab.active { background: #282a36; color: #fff; font-weight: bold; border-top: 2px solid var(--garuda-pink); }
    .terminal-win { background: rgba(10, 10, 15, 0.95); color: #0f0; font-family: 'Fira Code', monospace; padding: 10px; height: 100%; display: flex; flex-direction: column; }
    .term-prompt { color: var(--garuda-pink); margin-right: 8px; font-weight: bold; }
    .term-in { color: var(--garuda-cyan); }
  </style>
</head>
<body>

  <!-- NOTIFICATIONS -->
  <div class="notification-area" id="notif-area"></div>

  <!-- BSOD / CRASH SCREEN -->
  <div id="bsod-layer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0078d7; color:white; padding:100px; z-index:1000000; font-family:'Segoe UI'; cursor:none;" onclick="location.reload()">
      <h1 style="font-size:100px; margin:0;">:(</h1><h2>Your PC ran into a problem and needs to restart.</h2>
  </div>

  <!-- START MENU (Now positioned Top-Left or Center depending on CSS) -->
  <div id="start-menu">
      <input type="text" class="sm-search" placeholder="Search apps..." onkeyup="filterStartApps(this.value)">
      <div class="sm-grid" id="start-grid"></div>
      <div class="sm-footer">
          <div class="sm-user">
              <img src="" id="sm-avatar" class="sm-avatar">
              <strong id="sm-username">User</strong>
          </div>
          <div class="sm-actions">
              <i class="fas fa-lock sm-power" title="Lock" onclick="location.reload()"></i>
              <i class="fas fa-power-off sm-power" title="Shut Down" onclick="document.body.innerHTML='';document.body.style.background='black';"></i>
          </div>
      </div>
  </div>

  <!-- DEV TOOLS -->
  <div id="dev-panel">
    <h3>DEV_TOOLS v0.4</h3>
    <div class="dev-section"><button onclick="localStorage.clear();location.reload()" style="color:red;background:#300;border:1px solid red;width:100%;">FACTORY RESET</button></div>
    <div class="dev-section"><button onclick="devForceUnlock()">FORCE UNLOCK</button></div>
    <div class="dev-section">MEM: <span id="dev-mem">0</span> MB | UP: <span id="dev-up">0</span>s</div>
    <div class="dev-section" id="dev-log" style="height:200px;overflow-y:auto;font-size:10px;"></div>
    <button onclick="document.getElementById('dev-panel').classList.remove('active')">CLOSE</button>
  </div>

  <!-- AUTH SCREENS -->
  <div id="auth-layer">
    <div id="setup-screen" class="auth-container">
      <h2>Setup Mocha OS</h2>
      <input type="text" id="su-user" class="auth-input" placeholder="Username">
      <input type="password" id="su-pass" class="auth-input" placeholder="Password">
      <input type="password" id="su-conf" class="auth-input" placeholder="Confirm">
      <input type="text" id="su-pfp" class="auth-input" placeholder="Avatar URL">
      <button class="auth-btn" onclick="doSetup()">Create Account</button>
    </div>
    <div id="lock-screen" class="auth-container">
        <img src="" id="ls-avatar" style="width:80px;height:80px;border-radius:50%;margin-bottom:10px;object-fit:cover;">
        <h2 id="ls-user">User</h2>
        <input type="password" id="ls-pass" class="auth-input" placeholder="Password">
        <button class="auth-btn" onclick="doLogin()">Unlock</button>
    </div>
  </div>

  <!-- MAIN INTERFACE -->
  <div id="os-interface">
      
      <!-- TOP BAR (Status & Time) -->
      <div id="top-bar">
          <div class="tb-left" onclick="toggleStartMenu()">
              <i class="fab fa-linux"></i> <span>Mocha OS</span>
          </div>
          <div class="tb-center">
              <span id="clock-date">...</span> | <span id="clock">00:00</span>
          </div>
          <div class="tb-right">
              <i class="fas fa-volume-up"></i>
              <i class="fas fa-wifi"></i>
              <i class="fas fa-battery-three-quarters"></i>
          </div>
      </div>

      <!-- DESKTOP AREA -->
      <div class="desktop" id="desktop-icons"></div>

      <!-- SENTINEL WIDGET (Keeping it, but ensures it doesn't overlap) -->
      <div id="sentinel">
        <div class="header">
            <div class="time" id="clock-time" style="display:none;">00:00</div> <!-- Hidden as it's in top bar now -->
        </div>
        <div class="stage">
            <canvas id="viz-canvas"></canvas>
            <div class="controls-layer">
                <div class="track-info">
                    <div class="t-title" id="track-title">System Ready</div>
                    <div class="t-artist" id="track-artist">2025 Mix</div>
                </div>
                <div class="btn-row">
                    <i class="fas fa-step-backward icon-btn" onclick="changeTrack(-1)"></i>
                    <div class="play-circle" onclick="togglePlay()">
                        <i class="fas fa-play" id="play-icon"></i>
                    </div>
                    <i class="fas fa-step-forward icon-btn" onclick="changeTrack(1)"></i>
                </div>
                <div class="playlist-box" id="playlist-list"></div>
                <div class="s-actions" style="margin-top:15px;">
                    <div class="act-btn" title="Fullscreen" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></div>
                    <div class="act-btn" title="Performance Mode" onclick="togglePerformance()"><i class="fas fa-bolt"></i></div>
                    <div class="act-btn" title="Show Desktop" onclick="minimizeAll()"><i class="fas fa-desktop"></i></div>
                    <div class="act-btn" title="Do Not Disturb" onclick="toggleDND(this)"><i class="fas fa-moon"></i></div>
                </div>
            </div>
        </div>
      </div>

      <!-- BOTTOM DOCK (Apps Only) -->
      <div class="dock-container">
        <div class="dock" id="taskbar-list">
            <!-- Apps will be injected here by JS -->
        </div>
      </div>

  </div>
  
  <script>
    /* --- SYSTEM STATE & GLOBALS --- */
    /* GARUDA/CANDY THEME ICONS (Fluency Pack mimics Candy best) */
    const DEFAULT_APPS = [
      { id: 'files', name: 'File Explorer', icon: 'https://img.icons8.com/fluency/96/folder-invoices.png' },
      { id: 'browser', name: 'FireDragon', icon: 'https://img.icons8.com/fluency/96/firefox.png' }, /* Renamed to FireDragon for Garuda lore */
      { id: 'tasks', name: 'Tasks', icon: 'https://img.icons8.com/fluency/96/todo-list.png' },
      { id: 'terminal', name: 'Alacritty', icon: 'https://img.icons8.com/fluency/96/console.png' },
      { id: 'settings', name: 'Settings', icon: 'https://img.icons8.com/fluency/96/settings.png' },
      { id: 'store', name: 'Add/Remove', icon: 'https://img.icons8.com/fluency/96/software-box.png' },
      { id: 'notepad', name: 'Micro', icon: 'https://img.icons8.com/fluency/96/notepad.png' },
      { id: 'calc', name: 'Calculator', icon: 'https://img.icons8.com/fluency/96/calculator.png' },
      { id: 'vscode', name: 'Code', icon: 'https://img.icons8.com/fluency/96/visual-studio-code-2019.png' }
    ];

    let userProfile = null;
    let fileSystem = { 
        root: { 
            "Documents": {}, 
            "Downloads": {}, 
            "Pictures": {}, 
            "Music": {}
        } 
    };
    let activeWindows = {};
    let idleTime = 0;
    let dndMode = false;
    let zIndexCounter = 100; /* FIX: Layering counter */

    /* --- BOOT & AUTH --- */
    window.onload = () => {
        loadSystem();
        setInterval(() => { 
            const now = new Date();
            const timeString = now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            document.getElementById('clock').innerText = timeString;
            document.getElementById('clock-time').innerText = timeString;
            document.getElementById('clock-date').innerText = now.toLocaleDateString();
            idleTime++;
            if(idleTime > 300 && userProfile) location.reload(); 
        }, 1000);
        document.body.onmousemove = () => idleTime = 0;
        document.body.onkeydown = (e) => {
            idleTime = 0;
            if(e.key === 'F9') document.getElementById('dev-panel').classList.toggle('active');
        };
    };

    /* --- FUNCTIONAL BUTTONS --- */
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
            notify('System', 'Fullscreen Enabled');
        } else {
            document.exitFullscreen();
            notify('System', 'Fullscreen Disabled');
        }
    }

    function togglePerformance() {
        document.body.classList.toggle('perf-mode');
        const isPerf = document.body.classList.contains('perf-mode');
        notify('Performance Mode', isPerf ? 'ON (Blur Disabled)' : 'OFF (Blur Enabled)');
    }

    function minimizeAll() {
        const windows = document.querySelectorAll('.window');
        windows.forEach(win => {
            win.style.display = 'none';
            const icon = document.getElementById(win.id.replace('win-', 'tb-'));
            if(icon) icon.classList.remove('active');
        });
        notify('System', 'All windows minimized');
    }

    function toggleDND(el) {
        el.classList.toggle('active');
        dndMode = el.classList.contains('active');
        notify('Do Not Disturb', dndMode ? 'Enabled' : 'Disabled');
    }

    function loadSystem() {
        const savedUser = localStorage.getItem('yasu_user');
        const savedFS = localStorage.getItem('yasu_fs');
        if(savedFS) fileSystem = JSON.parse(savedFS);
        
        if(!savedUser) {
            document.getElementById('setup-screen').style.display = 'flex';
        } else {
            userProfile = JSON.parse(savedUser);
            document.getElementById('ls-user').innerText = userProfile.name;
            document.getElementById('ls-avatar').src = userProfile.pfp;
            document.getElementById('lock-screen').style.display = 'flex';
            /* Use profile BG if set, otherwise default CSS handles it */
            if(userProfile.bg) document.body.style.backgroundImage = `url('${userProfile.bg}')`;
        }
    }

    function doSetup() {
        const name = document.getElementById('su-user').value;
        const pass = document.getElementById('su-pass').value;
        const conf = document.getElementById('su-conf').value;
        const pfp = document.getElementById('su-pfp').value || 'https://img.icons8.com/fluency/96/user-male-circle.png';
        if(!name || !pass) return alert('Missing info');
        if(pass !== conf) return alert('Passwords do not match');
        
        userProfile = { name, pass, pfp, bg: '' };
        localStorage.setItem('yasu_user', JSON.stringify(userProfile));
        unlockOS();
    }

    function doLogin() {
        if(document.getElementById('ls-pass').value === userProfile.pass) unlockOS();
        else {
             document.getElementById('ls-pass').style.border = '1px solid red';
             notify('System', 'Incorrect Password'); 
        }
    }

    function unlockOS() {
        document.getElementById('auth-layer').style.opacity = 0;
        setTimeout(() => document.getElementById('auth-layer').style.display='none', 600);
        document.getElementById('os-interface').style.opacity = 1;
        document.getElementById('os-interface').style.pointerEvents = 'all';
        renderDesktop();
        renderStartMenu();
        notify('Welcome', `Logged in as ${userProfile.name}`);
    }

    /* --- WINDOW MANAGER --- */
    function openApp(id) {
        if(document.getElementById(`win-${id}`)) {
            toggleMinimize(id);
            bringToFront(id); /* FIX: Bring to front on reopen */
            return;
        }
        const app = DEFAULT_APPS.find(a => a.id === id);
        if(!app) return;

        const win = document.createElement('div');
        win.className = 'window';
        win.id = `win-${id}`;
        win.style.display = 'flex';
        win.style.zIndex = ++zIndexCounter; /* FIX: Initial Z-Index */
        win.onmousedown = () => bringToFront(id); /* FIX: Click to focus */
        
        win.innerHTML = `
            <div class="title-bar" onmousedown="dragWindow(event, '${win.id}')">
                <div class="controls">
                    <button class="ctl-btn close" onclick="closeWindow('${id}')"></button>
                    <button class="ctl-btn min" onclick="toggleMinimize('${id}')"></button>
                    <button class="ctl-btn max" onclick="toggleMaximize('${id}')"></button>
                </div>
                <span>${app.name}</span>
                <div style="width:40px"></div>
            </div>
            <div class="content" id="content-${id}"></div>
            <div class="resize-handle" onmousedown="resizeWindow(event, '${win.id}')"></div>
        `;

        document.body.appendChild(win);
        renderContent(id);
        addToTaskbar(id);
        win.style.animation = 'fadeInUp 0.3s forwards';
    }

    function bringToFront(id) {
        const win = document.getElementById(`win-${id}`);
        if(win) win.style.zIndex = ++zIndexCounter;
    }

    function closeWindow(id) {
        const win = document.getElementById(`win-${id}`);
        win.style.opacity = 0;
        setTimeout(() => win.remove(), 200);
        const icon = document.getElementById(`tb-${id}`);
        if(icon) icon.remove();
    }

    function toggleMinimize(id) {
        const win = document.getElementById(`win-${id}`);
        const tbIcon = document.getElementById(`tb-${id}`);
        if(win.style.display === 'none') {
            win.style.display = 'flex';
            win.style.opacity = 1;
            tbIcon.classList.add('active');
            bringToFront(id);
        } else {
            win.style.display = 'none';
            tbIcon.classList.remove('active');
        }
    }

    function toggleMaximize(id) {
        const win = document.getElementById(`win-${id}`);
        win.classList.toggle('maximized');
    }

    function addToTaskbar(id) {
        const app = DEFAULT_APPS.find(a => a.id === id);
        const tb = document.getElementById('taskbar-list');
        const img = document.createElement('img');
        img.src = app.icon;
        img.id = `tb-${id}`;
        img.className = 'active';
        img.onclick = () => toggleMinimize(id);
        tb.appendChild(img);
    }

    /* --- APP CONTENT RENDERER --- */
    function renderContent(id) {
        const container = document.getElementById(`content-${id}`);
        
        if(id === 'files') {
            container.innerHTML = `
                <div class="win10-explorer">
                    <div class="ribbon">
                        <div class="ribbon-tabs">
                            <div class="r-tab" style="background:#d93f87;color:white;border:none;">File</div>
                            <div class="r-tab active">Home</div>
                            <div class="r-tab">View</div>
                        </div>
                        <div class="ribbon-toolbar">
                            <div class="r-btn" onclick="w10CreateFolder()">
                                <i class="fas fa-folder-plus" style="color:#f8d775"></i><span>New folder</span>
                            </div>
                            <div class="r-btn" onclick="w10Delete()">
                                <i class="fas fa-times" style="color:#ff5f56"></i><span>Delete</span>
                            </div>
                        </div>
                    </div>
                    <div class="address-row">
                        <div class="nav-arrows">
                            <i class="fas fa-arrow-up" onclick="w10NavUp()"></i>
                        </div>
                        <div class="address-bar">
                            <i class="fas fa-desktop"></i>
                            <span id="w10-path">This PC</span>
                        </div>
                    </div>
                    <div class="explorer-body">
                        <div class="nav-pane">
                            <div class="nav-group-title">Quick access</div>
                            <div class="nav-item" onclick="w10Nav('Documents')"><i class="fas fa-file-alt nav-icon-blue"></i> Documents</div>
                            <div class="nav-item" onclick="w10Nav('Downloads')"><i class="fas fa-arrow-down nav-icon-blue"></i> Downloads</div>
                            <div class="nav-item" onclick="w10Nav('Pictures')"><i class="fas fa-image nav-icon-blue"></i> Pictures</div>
                        </div>
                        <div class="main-pane" id="w10-grid"></div>
                    </div>
                    <div class="status-bar" id="w10-status">0 items</div>
                </div>
            `;
            w10Refresh();
        } else if (id === 'browser') {
            container.innerHTML = `
                <div class="browser-tabs" id="btabs-${id}">
                    <div class="b-tab active">New Tab</div>
                    <div class="b-tab" onclick="addBrowserTab('${id}')">+</div>
                </div>
                <div class="browser-bar">
                    <i class="fas fa-arrow-left" style="cursor:pointer" onclick="document.getElementById('bf-${id}').contentWindow.history.back()"></i>
                    <i class="fas fa-redo" style="cursor:pointer" onclick="document.getElementById('bf-${id}').contentWindow.location.reload()"></i>
                    <input type="text" style="flex-grow:1;padding:5px;border-radius:15px;border:1px solid #ccc;" id="burl-${id}" placeholder="Search Google or enter URL">
                    <button onclick="navBrowser('${id}')">Go</button>
                </div>
                <iframe id="bf-${id}" class="browser-frame" src="https://www.google.com/webhp?igu=1"></iframe>
            `;
        } else if (id === 'tasks') {
            container.innerHTML = `
                <div class="task-input">
                    <input type="text" id="new-task" style="flex-grow:1;padding:8px;" placeholder="Add a task...">
                    <button onclick="addTask()">Add</button>
                </div>
                <div class="task-list" id="task-list"></div>
            `;
            renderTasks();
        } else if (id === 'terminal') {
            container.innerHTML = `
                <div class="terminal-win" onclick="document.getElementById('term-in').focus()">
                    <div class="term-out" id="term-out"></div>
                    <div class="term-input-line">
                        <span class="term-prompt">guest@garuda:~$</span>
                        <input type="text" class="term-in" id="term-in" onkeydown="termInput(this, event)" autocomplete="off" autofocus>
                    </div>
                </div>
            `;
            printTerm(`Welcome to Mocha OS (Dr460nized Edition)\nKernel: 6.5.9-zen1-1-zen\n`);
        } else if (id === 'notepad') {
            container.innerHTML = `<textarea style="width:100%;height:100%;border:none;padding:10px;resize:none;outline:none;background:#282a36;color:#f8f8f2;font-family:monospace;" placeholder="Type here..."></textarea>`;
        } else if (id === 'settings') {
            container.innerHTML = `<div style="padding:20px"><h3>Settings</h3><p>Background Image URL:</p><input id="bg-set" style="width:100%;padding:5px;"><button onclick="saveBg()">Save</button></div>`;
        } else if (id === 'store') { /* FIX: Added Store Content */
            container.innerHTML = `<div style="padding:50px; text-align:center;"><h2><i class="fas fa-box-open"></i> Add/Remove Software</h2><p>Pamac Manager v10.5</p><p>No updates available.</p></div>`;
        } else if (id === 'vscode') {
            container.innerHTML = `<iframe src="https://vscode.dev" style="width:100%;height:100%;border:none;"></iframe>`;
        } else if (id === 'calc') {
            container.innerHTML = `<iframe src="https://www.desmos.com/scientific" style="width:100%;height:100%;border:none;"></iframe>`;
        }
    }

    /* --- FILE EXPLORER LOGIC --- */
    let w10Path = ['root'];
    let w10Selected = null;
    function getDir(pathArr) { let ref = fileSystem; pathArr.forEach(p => { if(ref[p]) ref = ref[p]; }); return ref; }
    function w10Refresh() {
        const grid = document.getElementById('w10-grid'); if(!grid) return;
        grid.innerHTML = '<div class="file-grid-view" id="w10-icons"></div>';
        const target = document.getElementById('w10-icons');
        const currentDir = getDir(w10Path); const keys = Object.keys(currentDir);
        document.getElementById('w10-path').innerText = w10Path.length > 1 ? w10Path[w10Path.length-1] : 'This PC';
        document.getElementById('w10-status').innerText = `${keys.length} items`;
        keys.forEach(key => {
            const el = document.createElement('div'); el.className = 'w-file';
            const isObj = typeof currentDir[key] === 'object';
            el.onclick = (e) => {
                e.stopPropagation(); document.querySelectorAll('.w-file').forEach(x => x.classList.remove('selected'));
                el.classList.add('selected'); w10Selected = key;
                document.getElementById('w10-status').innerText = `${keys.length} items | 1 item selected`;
            }
            el.ondblclick = () => { if(isObj) { w10Path.push(key); w10Refresh(); } else { alert(`Opening ${key}...`); } };
            let iconHtml = isObj ? `<i class="fas fa-folder" style="color:#d93f87"></i>` : `<i class="fas fa-file" style="color:#00d9ff"></i>`;
            el.innerHTML = `${iconHtml}<span>${key}</span>`; target.appendChild(el);
        });
        document.querySelector('.main-pane').onclick = () => { document.querySelectorAll('.w-file').forEach(x => x.classList.remove('selected')); w10Selected = null; document.getElementById('w10-status').innerText = `${keys.length} items`; }
    }
    function w10Nav(folderName) { w10Path = ['root', folderName]; if(!fileSystem.root[folderName]) fileSystem.root[folderName] = {}; w10Refresh(); }
    function w10NavUp() { if(w10Path.length > 1) { w10Path.pop(); w10Refresh(); } }
    function w10CreateFolder() { const name = prompt("New Folder Name:", "New Folder"); if(name) { const dir = getDir(w10Path); dir[name] = {}; saveFS(); w10Refresh(); } }
    function w10Delete() { if(w10Selected) { const dir = getDir(w10Path); delete dir[w10Selected]; w10Selected = null; saveFS(); w10Refresh(); } else { alert("Select an item to delete."); } }
    function saveFS() { localStorage.setItem('yasu_fs', JSON.stringify(fileSystem)); }

    /* --- APP LOGIC: BROWSER --- */
    function navBrowser(id) {
        const val = document.getElementById(`burl-${id}`).value;
        const frame = document.getElementById(`bf-${id}`);
        if(val.includes('.')) frame.src = val.startsWith('http') ? val : 'https://' + val;
        else frame.src = `https://www.google.com/search?q=${encodeURIComponent(val)}&igu=1`;
    }

    /* --- APP LOGIC: TASKS --- */
    function renderTasks() {
        const list = document.getElementById('task-list');
        const tasks = JSON.parse(localStorage.getItem('yasu_tasks') || '[]');
        list.innerHTML = '';
        tasks.forEach((t, i) => {
            list.innerHTML += `<div class="task-row"><input type="checkbox" ${t.done?'checked':''} onclick="toggleTask(${i})"><span style="${t.done?'text-decoration:line-through;color:#aaa':''}">${t.text}</span><button onclick="delTask(${i})" style="margin-left:auto;color:red;border:none;background:none;">x</button></div>`;
        });
    }
    function addTask() {
        const txt = document.getElementById('new-task').value; if(!txt) return;
        const tasks = JSON.parse(localStorage.getItem('yasu_tasks') || '[]');
        tasks.push({text:txt, done:false}); localStorage.setItem('yasu_tasks', JSON.stringify(tasks));
        document.getElementById('new-task').value = ''; renderTasks();
    }
    function toggleTask(i) { const tasks = JSON.parse(localStorage.getItem('yasu_tasks')); tasks[i].done = !tasks[i].done; localStorage.setItem('yasu_tasks', JSON.stringify(tasks)); renderTasks(); }
    function delTask(i) { const tasks = JSON.parse(localStorage.getItem('yasu_tasks')); tasks.splice(i, 1); localStorage.setItem('yasu_tasks', JSON.stringify(tasks)); renderTasks(); }

    /* --- TERMINAL --- */
    let termHistory = [];
    let termHistoryIndex = -1;
    function printTerm(text) {
        const out = document.getElementById('term-out');
        if(out) { out.innerHTML += text; out.scrollTop = out.scrollHeight; }
    }
    function termInput(el, e) {
        if (e.key === 'ArrowUp') { e.preventDefault(); if (termHistoryIndex > 0) { termHistoryIndex--; el.value = termHistory[termHistoryIndex]; } } 
        else if (e.key === 'ArrowDown') { e.preventDefault(); if (termHistoryIndex < termHistory.length - 1) { termHistoryIndex++; el.value = termHistory[termHistoryIndex]; } else { termHistoryIndex = termHistory.length; el.value = ''; } } 
        else if (e.key === 'Enter') {
            const cmdLine = el.value.trim();
            const parts = cmdLine.split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);
            printTerm(`\n<span style="color:#00ff00">guest@garuda:~$</span> ${cmdLine}\n`);
            if(cmdLine) { termHistory.push(cmdLine); termHistoryIndex = termHistory.length; }
            switch(cmd) {
                case 'help': printTerm(`Commands: notify [t] [m], ls, mkdir, touch, cat, fetch, clear, reboot, matrix, dev, bsod\n`); break;
                case 'clear': document.getElementById('term-out').innerHTML = ''; break;
                case 'ls': printTerm(`<span style="color:#00d9ff">${Object.keys(fileSystem.root).join('  ')}</span>\n`); break;
                case 'touch': if(args[0]) { fileSystem.root[args[0]] = ""; saveFS(); printTerm(`File '${args[0]}' created.\n`); if(document.getElementById('w10-grid')) w10Refresh(); } else printTerm("Usage: touch [filename]\n"); break;
                case 'mkdir': if(args[0]) { fileSystem.root[args[0]] = {}; saveFS(); printTerm(`Directory '${args[0]}' created.\n`); if(document.getElementById('w10-grid')) w10Refresh(); } else printTerm("Usage: mkdir [dirname]\n"); break;
                case 'cat': if(args[0]) { const f = fileSystem.root[args[0]]; if(typeof f==='string')printTerm(`${f}\n`); else printTerm('Err\n'); } break;
                case 'notify': 
                    if(args.length >= 2) {
                        const title = args[0];
                        const msg = args.slice(1).join(" ");
                        notify(title, msg);
                        printTerm(`Notification sent.\n`);
                    } else printTerm("Usage: notify [title] [message]\n");
                    break;
                case 'fetch': printTerm(`Mocha OS (Dr460nized Edition)\nKernel: Web v1.0\nUser: ${userProfile.name}\nTheme: Dr460nized\n`); break;
                case 'reboot': location.reload(); break;
                case 'matrix': alert('Follow the white rabbit...'); break;
                case 'dev': document.getElementById('dev-panel').classList.add('active'); printTerm("Dev Panel Opened.\n"); break;
                case 'bsod': document.getElementById('bsod-layer').style.display = 'block'; break;
                case '': break;
                default: printTerm(`Command not found: ${cmd}\n`);
            }
            el.value = '';
        }
    }

    /* --- UI HELPERS --- */
    function notify(title, msg) {
        if(dndMode) return;
        const area = document.getElementById('notif-area');
        const t = document.createElement('div'); t.className = 'toast';
        t.innerHTML = `<i class="fas fa-info-circle"></i> <div><strong>${title}</strong><br>${msg}</div>`;
        area.appendChild(t);
        setTimeout(() => t.classList.add('show'), 10);
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
    }
    function renderDesktop() {
        const d = document.getElementById('desktop-icons'); d.innerHTML = '';
        DEFAULT_APPS.forEach(app => {
            d.innerHTML += `<div class="icon" ondblclick="openApp('${app.id}')"><img src="${app.icon}"><br><span>${app.name}</span></div>`;
        });
    }
    function renderStartMenu() {
        const g = document.getElementById('start-grid'); g.innerHTML = '';
        DEFAULT_APPS.forEach(app => {
            g.innerHTML += `<div class="sm-app" onclick="openApp('${app.id}');toggleStartMenu()"><img src="${app.icon}"><span>${app.name}</span></div>`;
        });
        document.getElementById('sm-username').innerText = userProfile.name;
        document.getElementById('sm-avatar').src = userProfile.pfp;
    }
    function toggleStartMenu() { document.getElementById('start-menu').classList.toggle('active'); }
    function saveBg() { const url = document.getElementById('bg-set').value; if(url) { document.body.style.backgroundImage = `url('${url}')`; userProfile.bg = url; localStorage.setItem('yasu_user', JSON.stringify(userProfile)); } }

    /* --- WINDOW DRAG LOGIC --- */
    let isDragging = false; let startX, startY, initialLeft, initialTop;
    function dragWindow(e, id) {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        isDragging = true;
        const win = document.getElementById(id);
        startX = e.clientX; startY = e.clientY;
        initialLeft = win.offsetLeft; initialTop = win.offsetTop;
        document.onmousemove = (ev) => {
            if(!isDragging) return;
            win.style.left = (initialLeft + ev.clientX - startX) + 'px';
            win.style.top = (initialTop + ev.clientY - startY) + 'px';
        };
        document.onmouseup = () => { isDragging = false; document.onmousemove = null; };
    }
    function resizeWindow(e, id) {
        const win = document.getElementById(id);
        const startW = win.offsetWidth; const startH = win.offsetHeight;
        const startX = e.clientX; const startY = e.clientY;
        e.stopPropagation();
        document.onmousemove = (ev) => {
            win.style.width = (startW + ev.clientX - startX) + 'px';
            win.style.height = (startH + ev.clientY - startY) + 'px';
        };
        document.onmouseup = () => { document.onmousemove = null; };
    }
    function devForceUnlock() { unlockOS(); }

    /* --- AUDIO SYSTEM --- */
    /* FIX: Defined audio global variable */
    const audio = document.getElementById('audio-player');
    const playIcon = document.getElementById('play-icon');
    
    const trackList = [
        { title: "NEON BLADE", artist: "MoonDeity", file: "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=phonk-music-112624.mp3" },
        { title: "CYBERPUNK", artist: "MaxKoMusic", file: "https://cdn.pixabay.com/download/audio/2022/06/27/audio_50827a6806.mp3?filename=phonk-115883.mp3" },
        { title: "NIGHT CITY", artist: "Synthwave", file: "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=trap-action-energetic-127421.mp3" }
    ];
    let currentIdx = 0; let isPlaying = false;
    let audioCtx, analyser, source;

    function renderPlaylist() {
        const list = document.getElementById('playlist-list');
        list.innerHTML = '';
        trackList.forEach((track, index) => {
            const div = document.createElement('div'); 
            div.className = `pl-item ${index === currentIdx ? 'active' : ''}`;
            div.onclick = () => loadTrack(index);
            div.innerHTML = `<span class="pl-title">${track.title}</span><div class="pl-anim"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>`;
            list.appendChild(div);
        });
    }
    function loadTrack(index) {
        if (index < 0) index = trackList.length - 1; if (index >= trackList.length) index = 0;
        currentIdx = index;
        const track = trackList[currentIdx];
        audio.src = track.file;
        document.getElementById('track-title').innerText = track.title; document.getElementById('track-artist').innerText = track.artist;
        renderPlaylist();
        if(isPlaying) { playIcon.className = 'fas fa-circle-notch fa-spin'; audio.play().then(() => playIcon.className = 'fas fa-pause'); }
    }
    function setupAudioContext() {
        if(audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        source = audioCtx.createMediaElementSource(audio);
        source.connect(analyser); analyser.connect(audioCtx.destination); analyser.fftSize = 128;
    }
    function togglePlay() {
        if (!audio.src) loadTrack(0);
        if (!audioCtx) setupAudioContext();
        if (audio.paused) { audio.play(); isPlaying = true; playIcon.className = 'fas fa-pause'; loop(); }
        else { audio.pause(); isPlaying = false; playIcon.className = 'fas fa-play'; }
    }
    function changeTrack(direction) { loadTrack(currentIdx + direction); if(!isPlaying) togglePlay(); }
    audio.addEventListener('ended', () => changeTrack(1));
    function loop() {
        if(!isPlaying) return; requestAnimationFrame(loop);
        const canvas = document.getElementById('viz-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight;
        const w = canvas.width; const h = canvas.height;
        const bufferLength = analyser.frequencyBinCount; const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, w, h);
        const barWidth = (w / bufferLength) * 1.5; let x = 0;
        for(let i = 0; i < bufferLength; i++) {
            let val = dataArray[i]; if (i < 8) val *= 1.2; 
            const barHeight = (val / 255) * (h * 0.75);
            const gradient = ctx.createLinearGradient(0, h/2 - barHeight/2, 0, h/2 + barHeight/2);
            /* Garuda Colors for Visualizer */
            gradient.addColorStop(0, '#ff007c'); 
            gradient.addColorStop(0.5, '#00d9ff'); 
            gradient.addColorStop(1, '#ff007c');
            ctx.fillStyle = gradient; ctx.beginPath();
            const y = (h - barHeight) / 2; ctx.roundRect(x, y, barWidth - 2, barHeight, 4); ctx.fill();
            x += barWidth;
        }
    }
    renderPlaylist();
    document.getElementById('track-title').innerText = trackList[0].title;
    document.getElementById('track-artist').innerText = trackList[0].artist;
  </script>
</body>
</html>
